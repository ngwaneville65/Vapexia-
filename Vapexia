#!/bin/bash
set -euo pipefail

# ---------------------------------
# Vapexia Manufacturing Group
# Automated Next.js ‚Üí Vercel Deploy
# ---------------------------------

SITE_URL="https://vapexiamfg.com"

echo "üöÄ Starting Vapexia deployment..."

# -------------------------------
# SAFETY CHECKS
# -------------------------------

if ! command -v npm >/dev/null 2>&1; then
  echo "‚ùå npm is not installed"
  exit 1
fi

if ! command -v vercel >/dev/null 2>&1; then
  echo "‚ùå Vercel CLI not installed"
  echo "Run: npm i -g vercel"
  exit 1
fi

if [ -z "${VERCEL_TOKEN:-}" ]; then
  echo "‚ùå VERCEL_TOKEN environment variable is missing"
  exit 1
fi

# -------------------------------
# INSTALL DEPENDENCIES
# -------------------------------

echo "üì¶ Installing dependencies..."
npm ci

# -------------------------------
# SITEMAP / ROBOTS
# -------------------------------

if [ -f "next-sitemap.config.js" ]; then
  echo "üó∫Ô∏è Generating sitemap & robots.txt..."
  npx next-sitemap
else
  echo "‚ö†Ô∏è next-sitemap.config.js not found ‚Äî skipping sitemap"
fi

# -------------------------------
# BUILD
# -------------------------------

echo "üèóÔ∏è Building Next.js site..."
npm run build

# -------------------------------
# DEPLOY
# -------------------------------

echo "‚òÅÔ∏è Deploying to Vercel (production)..."
vercel deploy --prod --confirm --token "$VERCEL_TOKEN"

# -------------------------------
# DONE
# -------------------------------

echo "‚úÖ Deployment successful!"
echo "üåê Live at: $SITE_URL"
